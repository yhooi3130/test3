#!/usr/bin/env bash
set -euxo pipefail

#####################################
# AAP connection settings
#####################################
AAP_HOST="10.0.3.196"
AAP_USER="admin"
AAP_PASS="aap@(xru5"

API="https://${AAP_HOST}/api/controller/v2"
AUTH="-k -s -u ${AAP_USER}:${AAP_PASS}"

CSV_FILE="hosts_list.csv"

#####################################
# Helpers
#####################################
api_get() {
  curl ${AUTH} "$1"
}

api_post() {
  curl ${AUTH} -X POST "$1" \
    -H "Content-Type: application/json" \
    -d "$2"
}

trim() {
  echo "$1" | xargs
}

remove_cr() {
  echo "$1" | tr -d '\r'
}

#####################################
# Cache organizations
#####################################
declare -A ORG_MAP

echo "ðŸ“¦ Loading organizations..."
while read -r id name; do
  ORG_MAP["$name"]="$id"
done < <(api_get "${API}/organizations/?page_size=200" | jq -r '.results[] | "\(.id) \(.name)"')

#####################################
# Inventory cache (org_id:name â†’ inv_id)
#####################################
declare -A INV_MAP

get_inventory_id() {
  local org_id="$1"
  local inv_name="$2"
  local key="${org_id}:${inv_name}"

  [[ -n "${INV_MAP[$key]:-}" ]] && {
    echo "${INV_MAP[$key]}"
    return
  }

  local inv_id
  inv_id=$(api_get \
    "${API}/inventories/?organization=${org_id}&name=${inv_name}" \
    | jq -r '.results[0].id // empty')

  if [[ -z "$inv_id" ]]; then
    echo "âž• Creating inventory '${inv_name}' (org_id=${org_id})"
    inv_id=$(api_post "${API}/inventories/" \
      "$(jq -n \
        --arg name "$inv_name" \
        --argjson org "$org_id" \
        '{name:$name, organization:$org}')" \
      | jq -r '.id')
  fi

  INV_MAP["$key"]="$inv_id"
  echo "$inv_id"
}

#####################################
# Host exists check
#####################################
host_exists() {
  local inv_id="$1"
  local host_name="$2"

  api_get "${API}/inventories/${inv_id}/hosts/?name=${host_name}" \
    | jq -e '.count > 0' >/dev/null
}

#####################################
# Main loop
#####################################
echo "ðŸš€ Processing CSV: ${CSV_FILE}"

# Skip header with tail, process all lines in current shell
while IFS=',' read -r org host inventory; do
  # Remove CR and trim spaces
  org=$(remove_cr "$org" | trim)
  host=$(remove_cr "$host" | trim)
  inventory=$(remove_cr "$inventory" | trim)

  # Skip empty lines
  [[ -z "$org" || -z "$host" || -z "$inventory" ]] && continue

  echo "Processing: org='$org', host='$host', inventory='$inventory'"

  org_id="${ORG_MAP[$org]:-}"
  if [[ -z "$org_id" ]]; then
    echo "âŒ Organization not found: $org"
    continue
  fi

  inv_id=$(get_inventory_id "$org_id" "$inventory")

  if host_exists "$inv_id" "$host"; then
    echo "âœ… Host exists: $host (inventory=$inventory)"
    continue
  fi

  echo "âž• Creating host: $host (inventory=$inventory)"
  api_post "${API}/inventories/${inv_id}/hosts/" \
    "$(jq -n \
      --arg name "$host" \
      --arg ahost "$host" \
      '{name:$name, variables: ("ansible_host: " + $ahost)}')" \
    >/dev/null

done < <(tail -n +2 "$CSV_FILE")  # Skip header

echo "ðŸŽ‰ Import completed successfully"
